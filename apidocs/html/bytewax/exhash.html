<main class="api__content">
<article class="api__article" id="content">
<header>
<h1 class="title">Module <code>bytewax.exhash</code></h1>
</header>
<section id="section-intro">
<p>Exhash is a consistent hash that Bytewax calls internally to
route data to workers.</p>
<p>We do not use Python's <code>hash</code> because it is not consistent between
processes by default and do not want to force modifying hash behavior
in unrelated code via
<a href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONHASHSEED"><code>PYTHONHASHSEED</code></a>.</p>
<p>If you need to route on a new key type, register a new version as is
done below in your own code. You <em>must</em> make sure that if two objects
are <code>x == y</code> they also are <code>exhash(x) == exhash(y)</code>.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Exhash is a consistent hash that Bytewax calls internally to
route data to workers.

We do not use Python&#39;s `hash` because it is not consistent between
processes by default and do not want to force modifying hash behavior
in unrelated code via
[`PYTHONHASHSEED`](https://docs.python.org/3/using/cmdline.html#envvar-PYTHONHASHSEED).

If you need to route on a new key type, register a new version as is
done below in your own code. You _must_ make sure that if two objects
are `x == y` they also are `exhash(x) == exhash(y)`.

&#34;&#34;&#34;
from functools import singledispatch
from hashlib import blake2b


@singledispatch
def exhash(key, h=None):
    &#34;&#34;&#34;A consistent hash of a value.&#34;&#34;&#34;
    raise NotImplementedError(f&#34;{type(key)} isn&#39;t exhash-able&#34;)


def new_hasher():
    &#34;&#34;&#34;Build a new `hashlib` hasher object.

    Override this if you want to use a different hashing method.

    &#34;&#34;&#34;
    return blake2b(digest_size=8)


@exhash.register
def _(key: list, h=None):
    raise NotImplementedError(&#34;can&#39;t exhash mutable list&#34;)


@exhash.register
def _(key: set, h=None):
    raise NotImplementedError(&#34;can&#39;t exhash mutable set&#34;)


@exhash.register
def _(key: dict, h=None):
    raise NotImplementedError(&#34;can&#39;t exhash mutable dict&#34;)


@exhash.register
def _(key: int, h=None):
    if h is None:
        h = new_hasher()
    h.update(key.to_bytes(key.bit_length() // 8 + 1, byteorder=&#34;little&#34;, signed=True))
    return h


@exhash.register
def _(key: str, h=None):
    if h is None:
        h = new_hasher()
    h.update(key.encode())
    return h


@exhash.register
def _(key: bytes, h=None):
    if h is None:
        h = new_hasher()
    h.update(key)
    return h


@exhash.register
def _(key: tuple, h=None):
    if h is None:
        h = new_hasher()
    for x in key:
        h = exhash(x, h)
    return h


@exhash.register
def _(key: frozenset, h=None):
    if h is None:
        h = new_hasher()
    for x in sorted(key):
        h = exhash(x, h)
    return h</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="bytewax.exhash.exhash"><code class="name flex">
<span>def <span class="ident">exhash</span></span>(<span>key, h=None)</span>
</code></dt>
<dd>
<div class="desc"><p>A consistent hash of a value.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@singledispatch
def exhash(key, h=None):
    &#34;&#34;&#34;A consistent hash of a value.&#34;&#34;&#34;
    raise NotImplementedError(f&#34;{type(key)} isn&#39;t exhash-able&#34;)</code></pre>
</details>
</dd>
<dt id="bytewax.exhash.new_hasher"><code class="name flex">
<span>def <span class="ident">new_hasher</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Build a new <code>hashlib</code> hasher object.</p>
<p>Override this if you want to use a different hashing method.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def new_hasher():
    &#34;&#34;&#34;Build a new `hashlib` hasher object.

    Override this if you want to use a different hashing method.

    &#34;&#34;&#34;
    return blake2b(digest_size=8)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav class="api__sidebar" id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul class="api__sidebar-nav" id="index">
<li class="api__sidebar-nav-item">
<h3 class="api__sidebar-nav-title">Super-module</h3>
<ul class="api__sidebar-nav-menu">
<li class="api__sidebar-nav-menu-item">
<code class="api__sidebar-nav-menu-id"><a title="bytewax" href="index.html">bytewax</a></code>
</li>
</ul>
</li>
<li class="api__sidebar-nav-item">
<h3 class="api__sidebar-nav-title">
<a href="#header-functions">Functions</a>
</h3>
<ul class="">
<li><code><a title="bytewax.exhash.exhash" href="#bytewax.exhash.exhash">exhash</a></code></li>
<li><code><a title="bytewax.exhash.new_hasher" href="#bytewax.exhash.new_hasher">new_hasher</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer class="api__footer" id="footer">
<p class="api__footer-copyright">
Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.
</p>
</footer>